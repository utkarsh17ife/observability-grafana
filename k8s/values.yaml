# =============================================================================
# OBSERVABILITY STACK - CONSOLIDATED VALUES
# =============================================================================
# This file contains configurations for all observability components.
# Uses MinIO from infrastructure namespace for object storage.
# Uses local-storage for persistent volumes.
# =============================================================================

# =============================================================================
# VICTORIA METRICS
# =============================================================================
vmsingle:
  enabled: false

vmcluster:
  enabled: true
  spec:
    retentionPeriod: 30d
    replicationFactor: 2
    vmstorage:
      replicaCount: 2
      storageDataPath: /vm-data
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: local-storage
            resources:
              requests:
                storage: 100Gi
      resources:
        requests:
          cpu: 500m
          memory: 1Gi
        limits:
          cpu: 2
          memory: 4Gi
    vmselect:
      replicaCount: 2
      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 1
          memory: 2Gi
    vminsert:
      replicaCount: 2
      resources:
        requests:
          cpu: 250m
          memory: 512Mi
        limits:
          cpu: 1
          memory: 2Gi

vmagent:
  enabled: true
  spec:
    scrapeInterval: 30s
    externalLabels:
      cluster: production
    resources:
      requests:
        cpu: 250m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

# =============================================================================
# LOKI (Distributed) - Using MinIO for object storage
# =============================================================================
loki:
  structuredConfig:
    auth_enabled: false
    schema_config:
      configs:
        - from: "2024-01-01"
          store: tsdb
          object_store: s3
          schema: v13
          index:
            prefix: loki_index_
            period: 24h
    storage_config:
      aws:
        # MinIO S3-compatible endpoint
        s3: s3://loki-chunks
        endpoint: minio.infrastructure.svc.cluster.local:9000
        region: us-east-1
        access_key_id: ${MINIO_ACCESS_KEY}
        secret_access_key: ${MINIO_SECRET_KEY}
        insecure: true
        s3forcepathstyle: true
      tsdb_shipper:
        active_index_directory: /loki/index
        cache_location: /loki/cache
    limits_config:
      ingestion_rate_mb: 10
      ingestion_burst_size_mb: 20
      max_streams_per_user: 10000
      max_entries_limit_per_query: 5000
      retention_period: 720h  # 30 days
    compactor:
      working_directory: /loki/compactor
      shared_store: s3
      retention_enabled: true

ingester:
  replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2
      memory: 4Gi
  persistence:
    enabled: true
    size: 50Gi
    storageClass: local-storage

querier:
  replicas: 2
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1
      memory: 2Gi

queryFrontend:
  replicas: 2
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

distributor:
  replicas: 2
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

gateway:
  enabled: true
  replicas: 2
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 256Mi

compactor:
  enabled: true
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1
      memory: 2Gi

serviceAccount:
  create: true
  name: loki

# =============================================================================
# PROMTAIL
# =============================================================================
promtail:
  config:
    clients:
      - url: http://loki-gateway.observability.svc.cluster.local/loki/api/v1/push
    snippets:
      pipelineStages:
        - docker: {}
        - static_labels:
            source: promtail
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# =============================================================================
# TEMPO (Distributed) - Using MinIO for object storage
# =============================================================================
storage:
  trace:
    backend: s3
    s3:
      bucket: tempo-traces
      endpoint: minio.infrastructure.svc.cluster.local:9000
      access_key: ${MINIO_ACCESS_KEY}
      secret_key: ${MINIO_SECRET_KEY}
      insecure: true
    blocklist_poll: 5m

tempo:
  retention: 720h  # 30 days
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1
      memory: 2Gi

# Tempo components
tempoIngester:
  replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2
      memory: 4Gi

tempoDistributor:
  replicas: 2

tempoQuerier:
  replicas: 2

tempoQueryFrontend:
  replicas: 2

tempoCompactor:
  enabled: true

# Tempo service account
tempoServiceAccount:
  create: true
  name: tempo

# =============================================================================
# OPENTELEMETRY COLLECTOR - DAEMON (runs on each node)
# =============================================================================
otelDaemon:
  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318
      hostmetrics:
        collection_interval: 30s
        scrapers:
          cpu: {}
          memory: {}
          disk: {}
          network: {}
      kubeletstats:
        collection_interval: 30s
        auth_type: serviceAccount
        endpoint: ${K8S_NODE_NAME}:10250
        insecure_skip_verify: true

    processors:
      batch:
        timeout: 10s
        send_batch_size: 1024
      memory_limiter:
        check_interval: 1s
        limit_mib: 512
        spike_limit_mib: 128
      k8sattributes:
        extract:
          metadata:
            - k8s.namespace.name
            - k8s.deployment.name
            - k8s.statefulset.name
            - k8s.daemonset.name
            - k8s.cronjob.name
            - k8s.job.name
            - k8s.pod.name
            - k8s.node.name

    exporters:
      otlp/gateway:
        endpoint: otel-gateway-opentelemetry-collector.observability.svc.cluster.local:4317
        tls:
          insecure: true

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlp/gateway]
        metrics:
          receivers: [otlp, hostmetrics, kubeletstats]
          processors: [memory_limiter, k8sattributes, batch]
          exporters: [otlp/gateway]

  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# =============================================================================
# OPENTELEMETRY COLLECTOR - GATEWAY (centralized deployment)
# =============================================================================
otelGateway:
  config:
    receivers:
      otlp:
        protocols:
          grpc:
            endpoint: 0.0.0.0:4317
          http:
            endpoint: 0.0.0.0:4318

    processors:
      batch:
        timeout: 10s
        send_batch_size: 1024
      memory_limiter:
        check_interval: 1s
        limit_mib: 1024
        spike_limit_mib: 256

    exporters:
      otlp/tempo:
        endpoint: tempo-distributor.observability.svc.cluster.local:4317
        tls:
          insecure: true
      prometheusremotewrite:
        endpoint: http://victoria-metrics-vmcluster-vminsert.observability.svc.cluster.local:8480/insert/0/prometheus/api/v1/write
        resource_to_telemetry_conversion:
          enabled: true
      loki:
        endpoint: http://loki-gateway.observability.svc.cluster.local/loki/api/v1/push

    service:
      pipelines:
        traces:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [otlp/tempo]
        metrics:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [prometheusremotewrite]
        logs:
          receivers: [otlp]
          processors: [memory_limiter, batch]
          exporters: [loki]

  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1
      memory: 1Gi

# =============================================================================
# GRAFANA
# =============================================================================
grafana:
  persistence:
    enabled: true
    storageClassName: local-storage
    size: 10Gi

  # Use existing secret for admin password
  # Create with: kubectl create secret generic grafana-admin -n observability --from-literal=admin-password=<your-password>
  admin:
    existingSecret: grafana-admin
    userKey: admin-user
    passwordKey: admin-password

  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
        - name: VictoriaMetrics
          type: prometheus
          url: http://victoria-metrics-vmcluster-vmselect.observability.svc.cluster.local:8481/select/0/prometheus
          isDefault: true
          jsonData:
            timeInterval: 30s

        - name: Loki
          type: loki
          url: http://loki-gateway.observability.svc.cluster.local
          jsonData:
            derivedFields:
              - datasourceUid: tempo
                matcherRegex: '"traceId":"(\w+)"'
                name: TraceID
                url: '$${__value.raw}'

        - name: Tempo
          type: tempo
          uid: tempo
          url: http://tempo-query-frontend.observability.svc.cluster.local:3100
          jsonData:
            tracesToLogs:
              datasourceUid: loki
              tags: ['job', 'instance', 'pod', 'namespace']
            serviceMap:
              datasourceUid: VictoriaMetrics
            nodeGraph:
              enabled: true
            lokiSearch:
              datasourceUid: loki

  service:
    type: ClusterIP

  ingress:
    enabled: false
